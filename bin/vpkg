#!/bin/bash

# requires: git, mr, vcsh

mr() {
   command mr "$@"
}

initool() {
   command git --file .mrconfig "$@"
}

plugin::add() {
    # TODO: add heuristics to handle:
    # - full URIs
    # - different repository types
    local repo name uri
    plugin_repo="$1"
    name="${plugin_repo##*/}"
    uri="https://github.com/${plugin_repo}.git/"
    cd "${bundles}"
    plugin::add::git "${name}" "${uri}"
    plugin::register "${name}"
}

plugin::add::git() {
    local name uri
    read -r name uri <<< "$@"
    git clone --recursive "${uri}" "${name}"
}

plugin::add::hg() {
    local name uri
    read -r name uri <<< "$@"
    hg clone "${uri}" "${name}"
}

plugin::add::svn() {
    local name uri
    read -r name uri <<< "$@"
    svn co "${uri}" "${name}"
}

plugin::delete() {
    local name
    read -r name <<< "$@"
    [[ -d "${name}" ]] && rm -rf "${name}"
    plugin::unregister "${name}"
}

plugin::register() {
    local name
    read -r name <<< "$@"
    mr register "${name}"
    vcsh "${cfg_repo}" add .mrconfig
    vcsh "${cfg_repo}" commit -m "Plugin ${name} registered in .mrconfig."
    if [[ -n "${vcsh_push}" ]]; then
        vcsh "${cfg_repo}" push
    fi
}

plugin::unregister() {
    local name
    read -r name <<< "$@"
    initool --remove-section "${name}" || true
    vcsh "${cfg_repo}" add .mrconfig
    vcsh "${cfg_repo}" commit -m "Plugin ${name} unregistered from .mrconfig."
    if [[ -n "${vcsh_push}" ]]; then
        vcsh "${cfg_repo}" push
    fi
}

plugin::update() {
    plugin::update::all
}

plugin::update::all() {
    vcsh "${cfg_repo}" pull
    mr -j4 update
}

plugin::list() {
    ls -d * | grep -v pathogen
}

vpkg::prep() {
    [[ -f "$HOME/.mrtrust" ]] || touch "$HOME/.mrtrust"
    grep -q "${bundles}/.mrconfig" "$HOME/.mrtrust" || \
        echo "${bundles}/.mrconfig" >> "$HOME/.mrtrust"
}


main() {
    set -e

    export bundles="$HOME/.vim/bundle"
    export cfg_repo="rc-vim"
    vpkg::prep

    cd "${bundles}"
    action="$1"; shift
    case "${action}" in
        add)
            plugin::add "$1" ;;
        del|delete|remove)
            plugin::delete "$1" ;;
        update)
            plugin::update ;;
        list)
            plugin::list ;;
        push)
            vcsh push ;;
    esac
}

main $@
